#!/bin/sh
#
# This script builds Varnish Cache in chroot from a tarball.
#
# Author: Lasse Karstensen <lkarsten@varnish-software.com>, March 2015.
# Author: Dridi Boukelmoune <dridi.boukelmoune@gmail.com>, March 2018.

set -e
set -u

ELVER=${ELVER:-el7}
CHROOT="epel-${ELVER#el}-x86_64"

rm -rf build
mkdir -p build
cd build

SOURCE=$(ls ../sources/varnish-*gz 2>/dev/null | tail -1)

tar xf "$SOURCE"

VERSION=$(./varnish-*/configure --version | awk 'NR == 1 {print $3}')
MAJOR=${VERSION%.*}
MINOR=${VERSION##*.}
MINOR=${MINOR%%-*}
RELEASE=${VERSION#*-}

cp -r -L ../redhat/* ./varnish-*/

TGZ_SOURCE=$(basename "$SOURCE" .tar.gz)
TGZ_SOURCE=$(basename "$TGZ_SOURCE" .tgz)
tar zcf "$TGZ_SOURCE.tgz" varnish-*/

if [ -n "${WEEKLY_VERSION:-}" ]; then
	RPMVERSION="${WEEKLY_VERSION}"
	RELEASE=weekly
else
	RPMVERSION="${MAJOR}.${MINOR}"
fi

# while debugging, disable make check since it takes 15-20 minutes to run.
sed -i -e 's/^make check/# make check/' */varnish.spec

mock() {
	command mock --old-chroot \
		--root "$CHROOT" \
		--uniqueext "worker${EXECUTOR_NUMBER:-}" \
		--resultdir "varnish-${MAJOR}/${ELVER}" \
		--define "_smp_mflags -j10" \
		--define "dist .${ELVER}" \
		--define "versiontag ${RPMVERSION}" \
		--define "releasetag ${RPMRELEASE:-1}" \
		--define "v_rc ${RELEASE}" \
		"$@"
}

mock --buildsrpm --source . --spec ./*/varnish.spec
mock --rebuild "varnish-${MAJOR}/${ELVER}"/varnish*.src.rpm
