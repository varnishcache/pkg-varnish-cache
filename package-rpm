#!/bin/sh
#
# This script builds Varnish Cache in chroot from a tarball.
#
# Author: Lasse Karstensen <lkarsten@varnish-software.com>, March 2015.
# Author: Dridi Boukelmoune <dridi.boukelmoune@gmail.com>, March 2018.

set -e
set -u

ELVER=${ELVER:-el7}

rm -rf build
mkdir -p build
cd build

SOURCE=$(ls ../sources/varnish-*gz 2>/dev/null | tail -1)

tar xf "$SOURCE"

DIST_DIR=$(ls)

VERSION=$("$DIST_DIR"/configure --version | awk 'NR == 1 {print $NF}')
MAJOR=${VERSION%.*}
MINOR=${VERSION##*.}
MINOR=${MINOR%%-*}
RELEASE=${VERSION#*-} # eg. beta1

cp -r -L ../redhat/* "$DIST_DIR"/

TGZ_SOURCE=$(basename "$SOURCE" .tar.gz)
TGZ_SOURCE=$(basename "$TGZ_SOURCE" .tgz)
tar zcf "$TGZ_SOURCE.tgz" "$DIST_DIR"/

if [ -n "${WEEKLY_VERSION:-}" ]; then
	RPMVERSION="${WEEKLY_VERSION}"
else
	RPMVERSION="${MAJOR}.${MINOR}"
fi

MOCK_ROOT="epel-${ELVER#el}-x86_64"
RESULT_DIR="varnish-${MAJOR}/${ELVER}"

mock() {
	command mock \
		--root "$MOCK_ROOT" \
		--uniqueext "worker${EXECUTOR_NUMBER:-}" \
		--resultdir "$RESULT_DIR" \
		--define "_smp_mflags -j10" \
		--define "dist .${ELVER}" \
		--define "versiontag ${RPMVERSION}" \
		--define "releasetag ${RPMRELEASE:-1}" \
		--define "srcname $DIST_DIR" \
		--define "v_rc ${RELEASE}" \
		--define "nocheck 1" \
		"$@"
	# XXX: no mechanism to make nocheck conditional
}

mock --buildsrpm --source . --spec "$DIST_DIR"/varnish.spec
mock --rebuild "$RESULT_DIR"/varnish-*.src.rpm
